# Feature Specification: 読書メモ表示機能

**Feature Branch**: `001-reading-notes-display`
**Created**: 2026-01-24
**Status**: Draft
**Input**: User description: "post以外のデータベースからも読み込んで表示する機能を作りたい。主に読書メモが対象であり、Notionのpropertyは以下です。title: string, topic:マルチセレクト, is_public: boolean, created_at:date です。UIとしてどのように表示するかは未定"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 読書メモ一覧の閲覧 (Priority: P1)

サイト訪問者として、公開されている読書メモの一覧を閲覧したい。これにより、サイト運営者が読んだ本やその内容を知ることができる。

**Why this priority**: 最も基本的な機能であり、この機能がなければ読書メモ機能自体が成立しない。ユーザーが読書メモにアクセスする主要な手段となる。

**Independent Test**: 読書メモ一覧ページにアクセスし、公開されている読書メモのタイトルと作成日が表示されることを確認することで、単独でテスト可能。最小限のMVPとして価値を提供できる。

**Acceptance Scenarios**:

1. **Given** Notionデータベースに公開設定(is_public=true)の読書メモが存在する、**When** ユーザーが読書メモ一覧ページにアクセスする、**Then** 公開されている読書メモのタイトルと作成日が一覧表示される
2. **Given** Notionデータベースに非公開設定(is_public=false)の読書メモが存在する、**When** ユーザーが読書メモ一覧ページにアクセスする、**Then** 非公開の読書メモは表示されない
3. **Given** 複数の読書メモが存在する、**When** ユーザーが一覧ページを表示する、**Then** 読書メモは作成日の新しい順で表示される

---

### User Story 2 - サイドメニューでのトピックフィルタリング (Priority: P2)

サイト訪問者として、サイドメニューに表示されているトピック一覧から特定のトピック(カテゴリ)を選択して、該当する読書メモのみを表示したい。これにより、興味のある分野の読書メモを効率的に探すことができる。

**Why this priority**: 基本的な閲覧機能が実装された後に、ユーザビリティを向上させる付加機能。読書メモの数が増えた際に特に有用となる。既存のpost機能のレイアウトパターン（サイドメニュー + メインコンテンツ）を踏襲することで、一貫したユーザー体験を提供する。

**Independent Test**: サイドメニューにトピック一覧を表示し、特定のトピックをクリックすると該当する読書メモのみがメインエリアに表示されることを確認することで、単独でテスト可能。既存の一覧表示機能に依存するが、独立した価値を提供する。

**Acceptance Scenarios**:

1. **Given** 読書メモページ(`/books`)にアクセスしている、**When** サイドメニューを表示する、**Then** "All"と全トピックのリストが表示され、"All"が選択状態になっている
2. **Given** サイドメニューでトピック一覧が表示されている、**When** ユーザーが特定のトピックをクリックする、**Then** 選択したトピックが付与されている読書メモのみがメインエリアに表示され、選択したトピックがアクティブ状態（ハイライト）になる
3. **Given** トピックフィルターが適用されている状態、**When** ユーザーがサイドメニューの"All"をクリックする、**Then** すべての公開読書メモが表示され、"All"がアクティブ状態になる
4. **Given** 複数のトピックが付与されている読書メモが存在する、**When** ユーザーがそのいずれかのトピックでフィルタリングする、**Then** その読書メモが結果に含まれる
5. **Given** モバイルデバイスでアクセスしている、**When** FloatingHeaderのメニューボタンをタップする、**Then** トピック一覧を含むMobileDrawerが表示される

---

### User Story 3 - 読書メモ詳細の閲覧 (Priority: P1)

サイト訪問者として、一覧から選択した読書メモの詳細内容を閲覧したい。これにより、本の感想や要点などの詳しい情報を得ることができる。

**Why this priority**: 一覧表示と同様に基本的な機能。タイトルだけでなく本文コンテンツを表示することで、読書メモ機能の本来の価値を提供する。

**Independent Test**: 読書メモ詳細ページにアクセスし、タイトル、トピック、作成日、本文内容が表示されることを確認することで、単独でテスト可能。一覧ページからの遷移ではなく、直接URLでアクセスしてもテスト可能。

**Acceptance Scenarios**:

1. **Given** 公開されている読書メモが存在する、**When** ユーザーが読書メモのタイトルをクリックする、**Then** 読書メモの詳細ページに遷移し、タイトル、トピック、作成日、本文内容が表示される
2. **Given** 非公開の読書メモのURLを知っている、**When** ユーザーが直接そのURLにアクセスする、**Then** アクセスが拒否されるか、404エラーが表示される
3. **Given** 読書メモにNotionブロック(段落、見出し、リストなど)が含まれている、**When** 詳細ページを表示する、**Then** これらのブロックが適切にフォーマットされて表示される

---

### Edge Cases

- 読書メモが1件も存在しない場合、一覧ページに適切なメッセージが表示される
- 選択したトピックに該当する読書メモが存在しない場合、その旨のメッセージが表示される
- Notion APIからのデータ取得に失敗した場合、エラーメッセージが表示され、システムがクラッシュしない
- トピックが設定されていない読書メモも正常に表示される
- 非常に長いタイトルや大量のトピックが設定されている場合でも、UIが崩れない
- 読書メモの本文に画像やコードブロックが含まれている場合でも、適切にレンダリングされる

## Requirements *(mandatory)*

### Functional Requirements

#### データ取得・表示

- **FR-001**: システムは、Notionデータベースから読書メモ(title, topic, is_public, created_at, 本文ブロック)を取得できなければならない
- **FR-002**: システムは、is_public=trueの読書メモのみを一般ユーザーに表示しなければならない
- **FR-003**: システムは、読書メモを作成日(created_at)の降順で表示しなければならない
- **FR-004**: システムは、Notionデータベースから全トピックの一覧を動的に取得できなければならない

#### ナビゲーション・ルーティング

- **FR-005**: ユーザーは、読書メモの一覧ページから個別の詳細ページに遷移できなければならない
- **FR-006**: システムは、読書メモ一覧ページ(`/books`)と詳細ページ(`/books/[id]`)に専用のルート(URL)を提供しなければならない
- **FR-007**: システムは、非公開(is_public=false)の読書メモへの直接URLアクセスを拒否しなければならない

#### トピックフィルタリング（サイドメニュー）

- **FR-008**: システムは、サイドメニューに"All"と全トピックのリストを表示しなければならない
- **FR-009**: ユーザーは、サイドメニューから特定のトピックを選択して読書メモをフィルタリングできなければならない
- **FR-010**: システムは、選択中のトピック（または"All"）をアクティブ状態（ハイライト）で表示しなければならない
- **FR-011**: ユーザーは、サイドメニューの"All"を選択してフィルターをクリアし、すべての読書メモを表示できなければならない

#### レスポンシブ対応

- **FR-012**: システムは、デスクトップ(1024px以上)ではサイドメニューを固定表示し、モバイル(1024px未満)ではFloatingHeaderとMobileDrawerを表示しなければならない

#### コンテンツレンダリング

- **FR-013**: システムは、読書メモの詳細ページで、タイトル、トピック、作成日、本文内容を表示しなければならない
- **FR-014**: システムは、読書メモに含まれるNotionブロック(段落、見出し、リスト、コード、画像、引用など)を適切にレンダリングしなければならない

### Key Entities

- **読書メモ (Reading Note)**: ユーザーが読んだ本に関するメモや感想を表現するエンティティ。以下の属性を持つ:
  - タイトル (title): 読書メモのタイトル(書籍名や概要など)
  - トピック (topic): 読書メモに付与されるカテゴリタグ(複数設定可能)
  - 公開フラグ (is_public): 一般ユーザーへの公開/非公開を制御
  - 作成日 (created_at): 読書メモが作成された日時
  - 本文ブロック: Notionで作成された本文コンテンツ(段落、見出し、リスト、コード、画像、引用などのブロック要素)

- **トピック (Topic)**: 読書メモを分類するためのカテゴリ。複数の読書メモに紐づけることができ、フィルタリングの基準となる

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーは、読書メモ一覧ページにアクセスしてから3秒以内に公開されている読書メモの一覧を閲覧できる
- **SC-002**: ユーザーは、読書メモのタイトルをクリックしてから2秒以内に詳細ページが表示される
- **SC-003**: 非公開の読書メモは、直接URLでアクセスしても100%の確率で表示されない(アクセス制御が正しく機能する)
- **SC-004**: トピックフィルター機能により、ユーザーは特定のカテゴリの読書メモを1クリックで絞り込める
- **SC-005**: 読書メモに含まれるすべての対応済みNotionブロックタイプ(段落、見出し、リスト、コード、画像、引用)が、視覚的に適切な形式で表示される
- **SC-006**: 読書メモが50件以上存在する場合でも、一覧ページの初期表示が5秒以内に完了する

## UI Design & Layout *(optional)*

読書メモ機能のUIデザインは、既存のpost機能のレイアウトパターンを踏襲します。

### レイアウト構造

**2カラムレイアウト: サイドメニュー + メインコンテンツ**

```
┌─────────────────────────────────────────────────────┐
│ グローバルサイドメニュー │ 読書メモサイドメニュー │ メインコンテンツ │
│ (年別リンク等)          │ (トピック一覧)       │ (読書メモ一覧/詳細) │
└─────────────────────────────────────────────────────┘
```

### サイドメニュー内容

**読書メモページ専用のサイドメニュー**:
- **"All"**: すべての読書メモを表示（デフォルト選択）
- **トピック一覧**: Notionデータベースから取得した全トピックをアルファベット順または日本語の五十音順で表示
- **アクティブ状態**: 選択中のトピックをハイライト表示（背景色変更、太字など）

### デスクトップ表示 (1024px以上)

- **サイドメニュー**: 固定表示（スティッキー配置）、幅は80-96w
- **メインコンテンツ**: スクロール可能なエリア
- **読書メモ一覧**: リスト形式で表示
  - 各アイテム: タイトル、作成日、トピックタグ
  - 現在表示中の読書メモをハイライト（詳細ページ表示時）

### モバイル表示 (1024px未満)

- **FloatingHeader**: スティッキーヘッダーでトピックメニューボタンを表示
- **MobileDrawer**: メニューボタンタップでトピック一覧を表示
- **ScrollArea**: 読書メモ一覧をスクロール表示
- **リスト形式**: border-bで区切られたシンプルなリストアイテム

### 読書メモ一覧ページ (`/books`)

- **URL**: `/books` (全読書メモ) または `/books?topic=トピック名` (フィルタリング)
- **表示内容**:
  - 読書メモのタイトル
  - 作成日（YYYY年MM月DD日 形式）
  - トピックタグ（複数表示可能、クリックでフィルタリング）
- **ソート順**: 作成日降順（新しいものが上）

### 読書メモ詳細ページ (`/books/[id]`)

- **URL**: `/books/[読書メモID]`
- **表示内容**:
  - タイトル（大見出し、4xl/5xl太字）
  - 作成日（サブタイトル、gray-400）
  - トピックタグ（クリック可能）
  - 本文（Notionブロックをレンダリング）
  - 戻るボタン（一覧ページへ）

### インタラクション

- **トピック選択**: サイドメニューのトピックをクリック → 該当する読書メモのみを一覧表示
- **"All"選択**: すべての読書メモを表示
- **トピックタグクリック**: 読書メモ詳細ページ内のトピックタグをクリック → そのトピックでフィルタリングされた一覧ページに遷移
- **アクティブ状態の視覚フィードバック**: 選択中のトピックや読書メモを明確に表示

## Assumptions *(optional)*

以下の前提条件に基づいて仕様を策定しています:

1. **既存UIパターンの踏襲**: post機能と同じレイアウト構造（サイドメニュー + メインコンテンツ）を採用し、一貫したユーザー体験を提供する
2. **再利用可能なコンポーネント**: 既存の `SideMenu`, `NavigationLink`, `ScrollArea`, `FloatingHeader`, `BlockRenderer` コンポーネントを活用する
3. **ページネーション**: 初期実装ではすべての読書メモを1ページに表示するが、将来的にページネーションや無限スクロールの追加を検討する
4. **トピックの動的取得**: トピック一覧はNotionデータベースから動的に取得し、ハードコードしない
5. **Notion APIキャッシュ**: 既存のpost機能と同様に、適切なキャッシュ戦略(時間単位または日単位)を採用し、Notion API呼び出しを最小化する
6. **エラーハンドリング**: データ取得に失敗した場合は、ユーザーフレンドリーなエラーメッセージを表示し、システムは継続して動作する
7. **ルーティング**: 既存のルート定義パターン(src/lib/routes.ts)に従い、`/books`パスを読書メモ機能に割り当てる(既存の`routes.books()`が利用可能)
8. **レスポンシブブレークポイント**: `lg` (1024px) をデスクトップ/モバイルの境界とする
9. **SEO対応**: 公開されている読書メモは検索エンジンにインデックスされる(Next.jsのSSR/SSGを活用)

## Out of Scope *(optional)*

以下の機能は、本フィーチャーの範囲外とします:

1. **読書メモの作成・編集・削除機能**: 読書メモはNotion上で管理され、本システムは表示のみを行う
2. **コメント機能**: ユーザーが読書メモにコメントを残す機能
3. **いいね・お気に入り機能**: ユーザーが読書メモをブックマークしたり評価したりする機能
4. **検索機能**: 読書メモ内のテキストを全文検索する機能(トピックフィルタリングは含む)
5. **ソート機能の追加**: 作成日降順以外のソート順(タイトル順、トピック順など)
6. **読書メモの統計表示**: 読んだ本の冊数、トピック別の集計などの分析機能
7. **関連する読書メモの推薦**: トピックやキーワードに基づいた推薦機能
8. **RSS/Atom フィード**: 読書メモの更新をフィードで配信する機能

## Dependencies *(optional)*

以下の既存機能やシステムに依存します:

### データ取得・パース機能

1. **Notion API統合**: `modules/notion/client.ts`および`modules/notion/service/api.ts`で定義されている既存のNotion API連携機能
2. **Notionブロックパーサー**: `modules/notion/service/parser.ts`のブロックパース機能を、読書メモのブロックにも適用
3. **Next.jsキャッシュ機能**: "use cache"ディレクティブを活用した既存のキャッシュ戦略

### UIコンポーネント（再利用）

4. **SideMenu**: `components/ui/SideMenu.tsx` - サイドメニューの基本構造
5. **NavigationLink**: `components/ui/MenuItem.tsx` - アクティブ状態付きナビゲーションリンク
6. **ScrollArea**: `components/ui/ScrollArea.tsx` - スクロール可能なコンテンツエリア
7. **FloatingHeader**: `components/layouts/FloatingHeader.tsx` - モバイル用スティッキーヘッダー
8. **BlockRenderer**: `modules/notion/ui/view/BlockRenderer.tsx` - Notionブロックのレンダリング
9. **PageTitle**: `components/ui/PageTitle.tsx` - ページタイトル表示用コンポーネント
10. **ErrorBoundary**: `components/ui/ErrorBoundary.tsx` - エラーハンドリング

### その他

11. **環境変数**: 読書メモ用のNotion データベースIDを環境変数として追加する必要がある(`NOTION_READING_NOTES_DATABASE_ID`など)
12. **ルーティングシステム**: `src/lib/routes.ts`で定義されている型安全なルーティング機構（`routes.books()`, `routes.books.detail(id)`など）
